# üé® –í–∏–∑—É–∞–ª—å–Ω—ã–µ –î–∏–∞–≥—Ä–∞–º–º—ã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## 1. –û–±—â–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –°–∏—Å—Ç–µ–º—ã

```mermaid
graph TB
    subgraph "Frontend / Client"
        Client[üë§ –ö–ª–∏–µ–Ω—Ç<br/>Browser/Mobile]
    end
    
    subgraph "Backend Server :8080"
        API[üåê GIN Router<br/>HTTP Server]
        
        subgraph "Handlers"
            RH[RouteHandler<br/>routes.go]
        end
        
        subgraph "Services"
            POI[POIService<br/>poi_service.go]
            GIS[GISService<br/>gis_service.go]
            CONTENT[ContentService<br/>content_service.go]
            TTS[TTSService<br/>tts_service.go]
        end
        
        subgraph "Models"
            MODELS[Models<br/>POI, Route, Waypoint, Content]
        end
    end
    
    subgraph "Database"
        PG[(PostgreSQL<br/>audioguid)]
    end
    
    subgraph "External APIs"
        DGIS[2GIS API<br/>Routing & Places]
        YGPT[YandexGPT<br/>Text Generation]
        YTTS[Yandex TTS<br/>Audio Synthesis]
        YSEARCH[Yandex Search<br/>Historical Info]
    end
    
    Client -->|HTTP Requests| API
    API --> RH
    RH --> POI
    RH --> GIS
    RH --> CONTENT
    RH --> TTS
    
    POI --> MODELS
    GIS --> MODELS
    CONTENT --> MODELS
    TTS --> MODELS
    
    POI <-->|SQL Queries| PG
    CONTENT <-->|Save Content| PG
    TTS <-->|Save Audio Path| PG
    
    GIS -->|Find Places<br/>Build Routes| DGIS
    CONTENT -->|Generate Text| YGPT
    CONTENT -->|Search Info| YSEARCH
    TTS -->|Synthesize Audio| YTTS
    
    style Client fill:#e1f5ff
    style API fill:#fff4e6
    style PG fill:#e8f5e9
    style DGIS fill:#fce4ec
    style YGPT fill:#fce4ec
    style YTTS fill:#fce4ec
```

## 2. –ü–æ—Ç–æ–∫ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ú–∞—Ä—à—Ä—É—Ç–∞

```mermaid
sequenceDiagram
    participant C as üë§ Client
    participant API as üåê API Handler
    participant POI as POIService
    participant DB as üíæ Database
    participant CONT as ContentService
    participant YGPT as YandexGPT
    participant TTS as Yandex TTS
    
    C->>API: POST /routes/generate<br/>{start_point, duration, epochs}
    
    API->>POI: FindNearby(lat, lon, radius, epochs)
    POI->>DB: SELECT * FROM pois WHERE...
    DB-->>POI: [POI1, POI2, POI3]
    POI-->>API: Filtered POIs (by distance & importance)
    
    API->>DB: INSERT INTO routes (name, duration, ...)
    DB-->>API: route_id
    
    API->>DB: INSERT INTO waypoints (route_id, poi_id, order)
    DB-->>API: waypoint_ids
    
    API-->>C: {route_id, waypoints}<br/>(content=null)
    
    Note over API,TTS: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    
    par –î–ª—è –∫–∞–∂–¥–æ–≥–æ waypoint
        API->>CONT: GenerateDescription(poi)
        
        CONT->>YGPT: POST /completion<br/>{prompt about POI}
        YGPT-->>CONT: Generated text (300-400 words)
        
        CONT->>TTS: GenerateAudio(text, waypoint_id)
        TTS->>YTTS: POST /tts:synthesize<br/>{text, voice=alena}
        YTTS-->>TTS: audio.mp3 (binary)
        TTS->>TTS: Save to ./audio/waypoint-id.mp3
        TTS-->>CONT: audio_path, duration
        
        CONT->>DB: INSERT INTO contents<br/>(waypoint_id, text, audio_path)
    end
    
    Note over C: Wait 1-2 minutes...
    
    C->>API: GET /routes/{route_id}
    API->>DB: SELECT route WITH waypoints AND contents
    DB-->>API: Full route data
    API-->>C: {route with content & audio_urls}
```

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö

```mermaid
erDiagram
    POIS ||--o{ WAYPOINTS : "referenced by"
    ROUTES ||--o{ WAYPOINTS : "has many"
    WAYPOINTS ||--|| CONTENTS : "has one"
    
    POIS {
        uuid id PK
        text name
        text description
        numeric latitude
        numeric longitude
        text epoch
        text category
        bigint importance
        bigint year_built
        text architect
        text style
        text_array photos
        timestamp created_at
    }
    
    ROUTES {
        uuid id PK
        text name
        text description
        numeric total_distance
        bigint estimated_duration
        text_array epochs
        text_array categories
        timestamp created_at
    }
    
    WAYPOINTS {
        uuid id PK
        uuid route_id FK
        uuid poi_id FK
        bigint order
        timestamp created_at
    }
    
    CONTENTS {
        uuid id PK
        uuid waypoint_id FK
        text text
        text audio_url
        text audio_path
        bigint duration
        text_array photos
        boolean generated
        timestamp created_at
    }
```

## 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å –û–ø–∏—Å–∞–Ω–∏–µ–º

```mermaid
graph TD
    ROOT[backend/]
    
    CMD[cmd/]
    SERVER[server/]
    MAIN[main.go<br/>üöÄ Entry Point<br/>Starts server]
    
    INTERNAL[internal/]
    
    API[api/]
    ROUTES[routes.go<br/>üîå Register endpoints]
    HANDLER[route_handler.go<br/>üì° HTTP logic]
    
    MODELS[models/]
    MODELSGO[models.go<br/>üìä Data structures<br/>POI, Route, etc]
    
    SERVICES[services/]
    POISVC[poi_service.go<br/>üó∫Ô∏è POI queries]
    GISSVC[gis_service.go<br/>üåç 2GIS integration]
    CONTSVC[content_service.go<br/>‚úçÔ∏è YandexGPT text]
    TTSSVC[tts_service.go<br/>üîä Yandex TTS audio]
    
    DB[database/]
    DBGO[postgres.go<br/>üíæ DB connection<br/>& migrations]
    
    CONFIG[config/]
    YAML[config.yaml<br/>‚öôÔ∏è Settings]
    
    AUDIO[audio/<br/>üéµ Generated MP3s]
    KEYS[keys/<br/>üîë API keys]
    
    ROOT --> CMD
    CMD --> SERVER
    SERVER --> MAIN
    
    ROOT --> INTERNAL
    INTERNAL --> API
    API --> ROUTES
    API --> HANDLER
    
    INTERNAL --> MODELS
    MODELS --> MODELSGO
    
    INTERNAL --> SERVICES
    SERVICES --> POISVC
    SERVICES --> GISSVC
    SERVICES --> CONTSVC
    SERVICES --> TTSSVC
    
    INTERNAL --> DB
    DB --> DBGO
    
    ROOT --> CONFIG
    CONFIG --> YAML
    
    ROOT --> AUDIO
    ROOT --> KEYS
    
    style MAIN fill:#ff6b6b
    style ROUTES fill:#4ecdc4
    style HANDLER fill:#4ecdc4
    style MODELSGO fill:#95e1d3
    style POISVC fill:#f9ca24
    style GISSVC fill:#f9ca24
    style CONTSVC fill:#f9ca24
    style TTSSVC fill:#f9ca24
    style DBGO fill:#6c5ce7
```

## 5. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π –¶–∏–∫–ª –ó–∞–ø—Ä–æ—Å–∞

```mermaid
stateDiagram-v2
    [*] --> ReceiveRequest: Client sends POST /routes/generate
    
    ReceiveRequest --> ValidateInput: Parse JSON body
    ValidateInput --> CalculateRadius: duration_minutes √ó 83 m/min
    
    CalculateRadius --> SearchPOIs: Call POIService.FindNearby()
    SearchPOIs --> QueryDatabase: SELECT FROM pois WHERE...
    QueryDatabase --> FilterDistance: Calculate Haversine distance
    FilterDistance --> SortByImportance: Order by importance DESC
    
    SortByImportance --> CheckResults: POIs found?
    CheckResults --> CreateRoute: Yes - Create route record
    CheckResults --> ReturnError: No - Return 404
    
    CreateRoute --> CreateWaypoints: INSERT waypoints for each POI
    CreateWaypoints --> StartAsyncGeneration: go generateContent()
    StartAsyncGeneration --> ReturnResponse: Return route_id + waypoints
    
    ReturnResponse --> [*]
    
    StartAsyncGeneration --> GenerateText: For each waypoint...
    GenerateText --> CallYandexGPT: POST to YandexGPT API
    CallYandexGPT --> GenerateAudio: Got text (300-400 words)
    GenerateAudio --> CallYandexTTS: POST to Yandex TTS
    CallYandexTTS --> SaveAudio: Save MP3 to ./audio/
    SaveAudio --> SaveContent: INSERT INTO contents
    SaveContent --> ContentComplete: Content ready
    
    ContentComplete --> [*]: Background process ends
    
    ReturnError --> [*]
```

## 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP Endpoints

```mermaid
flowchart LR
    subgraph "Client Requests"
        R1[GET /api/health]
        R2[GET /api/pois]
        R3[GET /api/pois/:id]
        R4[POST /api/routes/generate]
        R5[GET /api/routes/:id]
        R6[GET /api/audio/:waypoint_id]
    end
    
    subgraph "GIN Router"
        ROUTER{Router}
    end
    
    subgraph "Route Handler"
        H1[HealthCheck<br/>Return OK]
        H2[GetPOIs<br/>Query DB]
        H3[GetPOI<br/>Query by ID]
        H4[GenerateRoute<br/>Full logic]
        H5[GetRoute<br/>With preload]
        H6[GetAudio<br/>Return file]
    end
    
    subgraph "Services"
        S1[POIService]
        S2[ContentService]
        S3[TTSService]
    end
    
    subgraph "Data Layer"
        DB[(Database)]
        FS[File System<br/>./audio/]
    end
    
    R1 --> ROUTER
    R2 --> ROUTER
    R3 --> ROUTER
    R4 --> ROUTER
    R5 --> ROUTER
    R6 --> ROUTER
    
    ROUTER --> H1
    ROUTER --> H2
    ROUTER --> H3
    ROUTER --> H4
    ROUTER --> H5
    ROUTER --> H6
    
    H2 --> S1
    H3 --> S1
    H4 --> S1
    H4 --> S2
    H4 --> S3
    H5 --> DB
    H6 --> FS
    
    S1 --> DB
    S2 --> DB
    S3 --> FS
    
    style H4 fill:#ff6b6b
    style S1 fill:#4ecdc4
    style S2 fill:#95e1d3
    style S3 fill:#f9ca24
```

## 7. –ú–æ–¥–µ–ª–∏ –î–∞–Ω–Ω—ã—Ö –∏ –ò—Ö –°–≤—è–∑–∏

```mermaid
classDiagram
    class POI {
        +UUID ID
        +string Name
        +string Description
        +float64 Latitude
        +float64 Longitude
        +string Epoch
        +string Category
        +int Importance
        +int YearBuilt
        +string Architect
        +[]string Photos
        +TableName() string
    }
    
    class Route {
        +UUID ID
        +string Name
        +string Description
        +float64 TotalDistance
        +int EstimatedDuration
        +[]string Epochs
        +[]string Categories
        +[]Waypoint Waypoints
    }
    
    class Waypoint {
        +UUID ID
        +UUID RouteID
        +UUID POIID
        +POI POI
        +int Order
        +*Content Content
    }
    
    class Content {
        +UUID ID
        +UUID WaypointID
        +string Text
        +string AudioPath
        +string AudioURL
        +int Duration
        +[]string Photos
        +bool Generated
    }
    
    class RouteRequest {
        +Point StartPoint
        +int DurationMinutes
        +[]string Epochs
        +[]string Interests
        +int MaxWaypoints
    }
    
    class RouteResponse {
        +string RouteID
        +string Name
        +float64 TotalDistance
        +int EstimatedDuration
        +[]WaypointDetails Waypoints
    }
    
    Route "1" --> "*" Waypoint : has many
    Waypoint "*" --> "1" POI : references
    Waypoint "1" --> "0..1" Content : has one
    
    RouteRequest ..> Route : creates
    Route ..> RouteResponse : transforms to
```

## 8. –°–µ—Ä–≤–∏—Å—ã –∏ –ò—Ö –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

```mermaid
graph TB
    subgraph "POIService"
        PF[FindNearby<br/>lat, lon, radius]
        PG[GetByID<br/>uuid]
        PC[Create<br/>new POI]
        
        PF -->|Haversine| DIST[Calculate Distance]
        PF -->|Sort| SORT[By Importance]
    end
    
    subgraph "GISService"
        GF[FindPlacesNearby<br/>2GIS Catalog]
        GB[BuildRoute<br/>2GIS Routing]
        
        GF -->|HTTP GET| API1[catalog.api.2gis.com]
        GB -->|HTTP GET| API2[routing.api.2gis.com]
    end
    
    subgraph "ContentService"
        CF[GenerateDescription<br/>YandexGPT]
        CS[searchForPOI<br/>Yandex Search]
        
        CS -->|Optional| CF
        CF -->|Prompt| YGPT[YandexGPT API]
        YGPT -->|Text| CF
    end
    
    subgraph "TTSService"
        TG[GenerateAudio<br/>Yandex TTS]
        
        TG -->|Text| YTTS[Yandex TTS API]
        YTTS -->|MP3| FILE[./audio/uuid.mp3]
    end
    
    style PF fill:#e3f2fd
    style GF fill:#f3e5f5
    style CF fill:#fff3e0
    style TG fill:#e8f5e9
```

## 9. –ü—Ä–æ—Ü–µ—Å—Å –ü–æ–∏—Å–∫–∞ POI

```mermaid
flowchart TD
    START([Start: FindNearby])
    
    INPUT[Input:<br/>lat, lon, radius<br/>epochs, categories]
    
    QUERY[Build SQL Query<br/>WITH filters]
    
    DBQUERY[(SELECT * FROM pois<br/>WHERE epoch IN (...)<br/>AND category IN (...))]
    
    LOOP{For each POI}
    
    CALC[Calculate Distance<br/>Haversine formula]
    
    CHECK{Distance <= radius?}
    
    ADD[Add to results]
    
    SKIP[Skip POI]
    
    SORT[Sort by Importance<br/>DESC]
    
    RETURN[Return POI list]
    
    END([End])
    
    START --> INPUT
    INPUT --> QUERY
    QUERY --> DBQUERY
    DBQUERY --> LOOP
    LOOP -->|Yes| CALC
    CALC --> CHECK
    CHECK -->|Yes| ADD
    CHECK -->|No| SKIP
    ADD --> LOOP
    SKIP --> LOOP
    LOOP -->|No more| SORT
    SORT --> RETURN
    RETURN --> END
    
    style START fill:#4caf50
    style END fill:#f44336
    style CHECK fill:#ff9800
```

## 10. –§–æ—Ä–º–∞—Ç –î–∞–Ω–Ω—ã—Ö –Ω–∞ –ö–∞–∂–¥–æ–º –≠—Ç–∞–ø–µ

```mermaid
graph LR
    subgraph "1. Client Request"
        REQ["{<br/>start_point: {lat, lon},<br/>duration_minutes: 60,<br/>epochs: ['soviet'],<br/>interests: ['architecture']<br/>}"]
    end
    
    subgraph "2. After POI Search"
        POIS["[<br/>{id, name, lat, lon, epoch},<br/>{id, name, lat, lon, epoch},<br/>...<br/>]"]
    end
    
    subgraph "3. After Route Creation"
        ROUTE["{<br/>id: uuid,<br/>name: string,<br/>duration: int<br/>}"]
    end
    
    subgraph "4. After Waypoints"
        WPS["[<br/>{route_id, poi_id, order: 1},<br/>{route_id, poi_id, order: 2},<br/>...<br/>]"]
    end
    
    subgraph "5. Initial Response"
        RESP["{<br/>route_id: uuid,<br/>waypoints: [{id, name, lat, lon, content: null}]<br/>}"]
    end
    
    subgraph "6. After Content Gen"
        CONT["FOR EACH waypoint:<br/>{<br/>text: '–ò—Å—Ç–æ—Ä–∏—è –º–µ—Å—Ç–∞...',<br/>audio_path: './audio/uuid.mp3',<br/>duration: 180<br/>}"]
    end
    
    subgraph "7. Final Response"
        FINAL["{<br/>route_id,<br/>waypoints: [{<br/>id, name, lat, lon,<br/>content: {text, audio_url, duration}<br/>}]<br/>}"]
    end
    
    REQ --> POIS
    POIS --> ROUTE
    ROUTE --> WPS
    WPS --> RESP
    RESP -.Async.-> CONT
    CONT --> FINAL
```

---

## –ö–∞–∫ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –î–∏–∞–≥—Ä–∞–º–º—ã

### –í GitHub/GitLab
–≠—Ç–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –≤ Markdown –Ω–∞ GitHub/GitLab

### –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ PNG
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å mmdc (mermaid-cli)
npm install -g @mermaid-js/mermaid-cli

# –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
mmdc -i –î–ò–ê–ì–†–ê–ú–ú–´.md -o diagrams.png
```

### –û–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä
–û—Ç–∫—Ä–æ–π—Ç–µ https://mermaid.live/ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –¥–∏–∞–≥—Ä–∞–º–º—ã

### VS Code
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ "Markdown Preview Mermaid Support"

---

**–í—Å–µ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å–æ–∑–¥–∞–Ω—ã —Å –ø–æ–º–æ—â—å—é Mermaid - –ø—Ä–æ—Å—Ç–æ–≥–æ —è–∑—ã–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º –∏–∑ —Ç–µ–∫—Å—Ç–∞!** üé®
