# 🎧 Умный Аудиогид - Полная Документация

## 📋 Содержание

1. [Общая архитектура](#общая-архитектура)
2. [Структура кода](#структура-кода)
3. [Подробное описание компонентов](#подробное-описание-компонентов)
4. [Поток данных](#поток-данных)
5. [API Endpoints](#api-endpoints)
6. [База данных](#база-данных)
7. [Как запустить](#как-запустить)
8. [Примеры использования](#примеры-использования)
9. [Troubleshooting](#troubleshooting)

---

## 🏗 Общая Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                         КЛИЕНТ (Frontend/API)                   │
└───────────────────────────────┬─────────────────────────────────┘
                                │ HTTP Requests
                                ▼
┌────────────────────────────────────────────────────────────────┐
│                     GIN WEB SERVER (:8080)                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │              API HANDLERS (route_handler.go)              │ │
│  │  - GenerateRoute()  - GetRoute()  - GetPOIs()             │ │
│  └────────────────────┬──────────────────────────────────────┘ │
└───────────────────────┼────────────────────────────────────────┘
                        │
       ┌────────────────┼────────────────┐
       │                │                │
       ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌───────────────┐
│ POI Service  │ │  GIS Service │ │Content Service│
│              │ │              │ │               │
│ - FindNearby │ │ - FindPlaces │ │ - GenerateText│
│ - GetByID    │ │ - BuildRoute │ │ - YandexGPT   │
└──────┬───────┘ └──────┬───────┘ └────────┬──────┘
       │                │                  │
       │                │                  │
       ▼                ▼                  ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  PostgreSQL  │ │  2GIS API    │ │ Yandex APIs  │
│   Database   │ │              │ │  - GPT       │
│              │ │              │ │  - TTS       │
│  - pois      │ │              │ │  - Search    │
│  - routes    │ │              │ │              │
│  - waypoints │ │              │ │              │
│  - contents  │ │              │ │              │
└──────────────┘ └──────────────┘ └──────────────┘
```

---

## 📁 Структура Кода

```
backend/
├── cmd/
│   └── server/
│       └── main.go              # 🚀 Точка входа приложения
│
├── internal/
│   ├── api/                     # 🌐 HTTP обработчики
│   │   ├── routes.go            # Регистрация всех endpoints
│   │   └── route_handler.go    # Логика обработки запросов
│   │
│   ├── models/                  # 📊 Модели данных
│   │   └── models.go            # POI, Route, Waypoint, Content
│   │
│   ├── services/                # 🔧 Бизнес-логика
│   │   ├── poi_service.go       # Работа с местами интереса
│   │   ├── gis_service.go       # Интеграция с 2GIS
│   │   ├── content_service.go   # Генерация текста (YandexGPT)
│   │   └── tts_service.go       # Генерация аудио (Yandex TTS)
│   │
│   └── database/                # 💾 Работа с БД
│       └── postgres.go          # Подключение и миграции
│
├── config/
│   └── config.yaml              # ⚙️ Конфигурация
│
├── audio/                       # 🔊 Сгенерированные аудиофайлы
├── keys/                        # 🔑 API ключи
│   └── 2gis.key
│
├── go.mod                       # 📦 Зависимости Go
└── .env                         # 🔐 Переменные окружения
```

---

## 🔍 Подробное Описание Компонентов

### 1. `cmd/server/main.go` - Точка входа

**Что делает:**
- Загружает переменные окружения из `.env`
- Подключается к PostgreSQL
- Выполняет миграции БД
- Запускает GIN веб-сервер на порту 8080
- Регистрирует все API endpoints

**Код:**
```go
func main() {
    // 1. Загрузка .env
    godotenv.Load()
    
    // 2. Подключение к БД
    db, err := database.Connect()
    
    // 3. Миграции (создание таблиц)
    database.Migrate(db)
    
    // 4. Настройка роутера
    router := gin.Default()
    
    // 5. Регистрация endpoints
    api.RegisterRoutes(router, db)
    
    // 6. Запуск сервера
    router.Run(":8080")
}
```

**Поток выполнения:**
1. Читает `DATABASE_URL` из env
2. Создает connection pool к PostgreSQL
3. Создает таблицы если их нет
4. Инициализирует все сервисы
5. Слушает HTTP запросы на `:8080`

---

### 2. `internal/models/models.go` - Модели данных

#### **POI (Point of Interest) - Место интереса**

```go
type POI struct {
    ID          uuid.UUID      // Уникальный ID
    Name        string         // Название (ВДНХ, Кремль)
    Description string         // Краткое описание
    Latitude    float64        // Широта (55.7558)
    Longitude   float64        // Долгота (37.6173)
    Epoch       string         // Эпоха: medieval, imperial, soviet, modern
    Category    string         // Категория: architecture, history, art
    Importance  int            // Важность 1-10
    YearBuilt   int            // Год постройки
    Architect   string         // Архитектор
    Style       string         // Стиль архитектуры
    Photos      pq.StringArray // Массив URL фотографий
    CreatedAt   time.Time      // Когда создан
    UpdatedAt   time.Time      // Когда обновлен
}
```

**Где хранится:** Таблица `pois` в PostgreSQL  
**Как создается:** Через SQL скрипт `scripts/import_sample_pois.py`  
**Пример:**
```json
{
  "id": "179fd8c2-37cb-4c7d-8d7b-7fe0fd564d7f",
  "name": "ВДНХ",
  "latitude": 55.8304,
  "longitude": 37.6325,
  "epoch": "soviet",
  "category": "architecture",
  "importance": 10
}
```

---

#### **Route - Маршрут**

```go
type Route struct {
    ID                uuid.UUID      // ID маршрута
    Name              string         // "Советская Москва: Архитектура"
    Description       string         // Описание маршрута
    TotalDistance     float64        // Общая дистанция в метрах
    EstimatedDuration int            // Длительность в минутах
    Waypoints         []Waypoint     // Список точек маршрута
    Epochs            pq.StringArray // ["soviet", "medieval"]
    Categories        pq.StringArray // ["architecture", "history"]
    CreatedAt         time.Time      // Когда создан
}
```

**Где хранится:** Таблица `routes`  
**Как создается:** Через POST `/api/routes/generate`  
**Связи:** Имеет много Waypoints (одна точка маршрута = один waypoint)

---

#### **Waypoint - Точка на маршруте**

```go
type Waypoint struct {
    ID        uuid.UUID  // ID waypoint
    RouteID   uuid.UUID  // К какому маршруту относится
    POIID     uuid.UUID  // ID места интереса
    POI       POI        // Полные данные места
    Order     int        // Порядок (1, 2, 3...)
    Content   *Content   // Контент (текст + аудио)
    CreatedAt time.Time
}
```

**Где хранится:** Таблица `waypoints`  
**Связи:**
- `RouteID` → `routes.id` (принадлежит маршруту)
- `POIID` → `pois.id` (ссылается на место)
- `Content` → генерируется асинхронно

**Пример связи:**
```
Route "Советская Москва"
  ├─ Waypoint #1 → POI "ВДНХ" → Content (текст + audio.mp3)
  ├─ Waypoint #2 → POI "МГУ" → Content (текст + audio.mp3)
  └─ Waypoint #3 → POI "Останкинская башня" → Content (текст + audio.mp3)
```

---

#### **Content - Контент для точки**

```go
type Content struct {
    ID         uuid.UUID      // ID контента
    WaypointID uuid.UUID      // К какому waypoint относится
    Text       string         // Сгенерированный текст (300-400 слов)
    AudioPath  string         // Путь к MP3 файлу
    AudioURL   string         // URL для скачивания (/api/audio/uuid)
    Duration   int            // Длительность аудио в секундах
    Photos     pq.StringArray // Фотографии
    Generated  bool           // true если сгенерировано
    CreatedAt  time.Time
}
```

**Где хранится:** Таблица `contents`  
**Как создается:** Асинхронно после создания waypoint  
**Процесс генерации:**
1. YandexGPT генерирует текст (2-3 минуты чтения)
2. Yandex TTS создает MP3 из текста
3. Сохраняет в `./audio/waypoint-id.mp3`
4. Записывает в БД

---

### 3. `internal/services/` - Сервисы (Бизнес-логика)

#### **POIService** - Работа с местами интереса

**Файл:** `poi_service.go`

**Методы:**

##### `FindNearby()` - Поиск мест рядом с точкой

```go
func (s *POIService) FindNearby(
    lat, lon float64,        // Координаты начальной точки
    radiusMeters float64,    // Радиус поиска в метрах
    epochs []string,         // Фильтр по эпохам
    categories []string,     // Фильтр по категориям
) ([]models.POI, error)
```

**Что делает:**
1. Запрашивает все POI из БД с фильтрами по эпохе и категории
2. Вычисляет расстояние от начальной точки до каждого POI (формула Haversine)
3. Отбирает только те, что в радиусе
4. Сортирует по важности (importance)
5. Возвращает отсортированный список

**Формула расстояния (Haversine):**
```go
func calculateDistance(lat1, lon1, lat2, lon2 float64) float64 {
    const earthRadius = 6371000.0 // метры
    
    // Переводим в радианы
    lat1Rad := lat1 * math.Pi / 180
    lat2Rad := lat2 * math.Pi / 180
    deltaLat := (lat2 - lat1) * math.Pi / 180
    deltaLon := (lon2 - lon1) * math.Pi / 180
    
    // Формула Haversine
    a := sin²(Δlat/2) + cos(lat1) × cos(lat2) × sin²(Δlon/2)
    c := 2 × atan2(√a, √(1−a))
    
    return earthRadius × c  // расстояние в метрах
}
```

**Пример:**
```go
// Поиск советских памятников в радиусе 5км от Красной площади
pois, _ := poiService.FindNearby(
    55.7539, 37.6208,     // Красная площадь
    5000,                  // 5 км
    []string{"soviet"},    // Советская эпоха
    []string{"architecture"}, // Архитектура
)
// Вернет: [ВДНХ, МГУ, Останкино, ...]
```

---

#### **GISService** - Работа с 2GIS API

**Файл:** `gis_service.go`

**Методы:**

##### `FindPlacesNearby()` - Поиск мест через 2GIS

```go
func (s *GISService) FindPlacesNearby(
    lat, lon, radius float64,
    query string,           // Поисковый запрос
) ([]Place, error)
```

**Что делает:**
1. Формирует запрос к 2GIS Catalog API
2. Ищет места по запросу в радиусе
3. Возвращает список мест с координатами

**API запрос:**
```
GET https://catalog.api.2gis.com/3.0/items
  ?key={API_KEY}
  &point={lon},{lat}
  &radius={radius}
  &q={query}
```

**Пример:**
```go
places, _ := gisService.FindPlacesNearby(
    55.7558, 37.6173,
    2000,
    "музей",
)
// Вернет места из 2GIS API
```

##### `BuildRoute()` - Построение маршрута

```go
func (s *GISService) BuildRoute(
    points []RoutePoint,    // Список точек
    routeType string,       // "pedestrian" или "car"
) (*RouteResult, error)
```

**Что делает:**
1. Отправляет точки в 2GIS Routing API
2. Получает оптимальный маршрут
3. Возвращает расстояние, время, геометрию

**API запрос:**
```
GET https://catalog.api.2gis.com/routing/7.0.0/global
  ?key={API_KEY}
  &type=pedestrian
  &points={lon1},{lat1};{lon2},{lat2};...
```

**Ответ:**
```json
{
  "total_distance": 4500,  // метры
  "total_duration": 3600,  // секунды
  "geometry": [[37.6173, 55.7558], [37.6325, 55.8304], ...]
}
```

---

#### **ContentService** - Генерация контента

**Файл:** `content_service.go`

##### `GenerateDescription()` - Генерация текста

```go
func (s *ContentService) GenerateDescription(
    poi models.POI,
) (string, error)
```

**Что делает:**

**Шаг 1:** Поиск дополнительной информации (опционально)
```go
if s.searchUser != "" {
    // Ищем через Yandex Search API
    additionalInfo := searchForPOI(poi)
}
```

**Шаг 2:** Формирование промпта для YandexGPT
```go
prompt := fmt.Sprintf(`
Создай увлекательный рассказ для аудиогида о следующем месте:

Название: %s
Описание: %s
Эпоха: %s
Год постройки: %d
Архитектор: %s

Требования:
- Длина: 2-3 минуты чтения (300-400 слов)
- Стиль: живой, увлекательный
- Включи интересные факты
- Обращайся на "вы"
`, poi.Name, poi.Description, poi.Epoch, poi.YearBuilt, poi.Architect)
```

**Шаг 3:** Запрос к YandexGPT
```json
POST https://llm.api.cloud.yandex.net/foundationModels/v1/completion
{
  "modelUri": "gpt://folder_id/yandexgpt/latest",
  "messages": [
    {"role": "system", "text": "Ты профессиональный экскурсовод..."},
    {"role": "user", "text": "{prompt}"}
  ],
  "completionOptions": {
    "temperature": 0.7,
    "maxTokens": "1000"
  }
}
```

**Шаг 4:** Получение ответа
```json
{
  "result": {
    "alternatives": [{
      "message": {
        "text": "Перед вами знаменитая ВДНХ - грандиозный выставочный комплекс..."
      }
    }]
  }
}
```

**Возвращает:** Сгенерированный текст (300-400 слов)

---

#### **TTSService** - Генерация аудио

**Файл:** `tts_service.go`

##### `GenerateAudio()` - Создание MP3

```go
func (s *TTSService) GenerateAudio(
    text string,      // Текст для озвучивания
    filename string,  // waypoint-id
) (audioPath string, duration int, error)
```

**Что делает:**

**Шаг 1:** Формирование запроса к Yandex SpeechKit
```
POST https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize
  ?text={text}
  &lang=ru-RU
  &voice=alena
  &speed=1.0
  &format=mp3
  &folderId={folder_id}

Headers:
  Authorization: Api-Key {api_key}
```

**Шаг 2:** Получение аудио (бинарные данные MP3)

**Шаг 3:** Сохранение в файл
```go
audioPath := "./audio/waypoint-uuid.mp3"
file.Write(audioData)
```

**Шаг 4:** Расчет длительности
```go
// Примерно 150 слов в минуту
words := len(text) / 5
durationSeconds := (words * 60) / 150
```

**Возвращает:**
- `audioPath`: "./audio/123e4567-e89b-12d3-a456-426614174000.mp3"
- `duration`: 180 (секунд)

**Доступные голоса:**
- `alena` - мягкий женский (рекомендуется)
- `filipp` - нейтральный мужской
- `jane` - эмоциональный женский
- `ermil` - эмоциональный мужской

---

### 4. `internal/api/route_handler.go` - HTTP обработчики

#### `GenerateRoute()` - Генерация маршрута

**Endpoint:** `POST /api/routes/generate`

**Входные данные:**
```json
{
  "start_point": {
    "lat": 55.7558,
    "lon": 37.6173
  },
  "duration_minutes": 60,
  "epochs": ["soviet", "medieval"],
  "interests": ["architecture", "history"],
  "max_waypoints": 5
}
```

**Алгоритм работы:**

```
┌─────────────────────────────────────────────────┐
│ 1. Получение запроса                            │
│    - Парсинг JSON                               │
│    - Валидация параметров                       │
└───────────────┬─────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────┐
│ 2. Расчет радиуса поиска                        │
│    radius = duration_minutes × 83 м/мин         │
│    (средняя скорость пешехода)                  │
│    Пример: 60 мин × 83 = 4980 метров           │
└───────────────┬─────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────┐
│ 3. Поиск POI                                    │
│    poiService.FindNearby(                       │
│      lat, lon, radius,                          │
│      epochs, interests                          │
│    )                                            │
│    ↓                                            │
│    Возвращает: [POI1, POI2, POI3, ...]         │
└───────────────┬─────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────┐
│ 4. Проверка количества                          │
│    if len(pois) == 0:                           │
│      return error "No POIs found"               │
│                                                 │
│    if len(pois) > max_waypoints:                │
│      pois = pois[:max_waypoints]                │
└───────────────┬─────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────┐
│ 5. Создание маршрута в БД                       │
│    route = Route{                               │
│      Name: "Советская Москва: Архитектура",     │
│      EstimatedDuration: 60,                     │
│      Epochs: ["soviet"],                        │
│      Categories: ["architecture"]               │
│    }                                            │
│    db.Create(&route)                            │
└───────────────┬─────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────┐
│ 6. Создание waypoints                           │
│    for i, poi := range pois {                   │
│      waypoint = Waypoint{                       │
│        RouteID: route.ID,                       │
│        POIID: poi.ID,                           │
│        Order: i + 1                             │
│      }                                          │
│      waypoints = append(waypoints, waypoint)    │
│    }                                            │
│    db.Create(&waypoints)                        │
└───────────────┬─────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────┐
│ 7. Запуск генерации контента (асинхронно)      │
│    go generateContentForWaypoints(waypoints)    │
│    ↓                                            │
│    В фоне для каждого waypoint:                 │
│    - Генерирует текст через YandexGPT           │
│    - Создает аудио через Yandex TTS             │
│    - Сохраняет в БД                             │
└───────────────┬─────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────┐
│ 8. Формирование ответа                          │
│    response = {                                 │
│      route_id: "uuid",                          │
│      name: "Советская Москва",                  │
│      waypoints: [...]                           │
│    }                                            │
│    return JSON                                  │
└─────────────────────────────────────────────────┘
```

**Выходные данные:**
```json
{
  "route_id": "ea7a7092-8fa1-44c2-a656-55f38d4822e3",
  "name": "Советская Москва: Архитектура",
  "total_distance": 0,
  "estimated_duration": 60,
  "waypoints": [
    {
      "id": "waypoint-uuid-1",
      "name": "ВДНХ",
      "description": "Выставка достижений...",
      "coordinates": {"lat": 55.8304, "lon": 37.6325},
      "epoch": "soviet",
      "category": "architecture",
      "order": 1,
      "content": null  // генерируется асинхронно
    }
  ]
}
```

---

#### `GetRoute()` - Получение деталей маршрута

**Endpoint:** `GET /api/routes/:route_id`

**Алгоритм:**
1. Парсит `route_id` из URL
2. Загружает маршрут из БД с Preload:
   ```go
   db.Preload("Waypoints.POI").
      Preload("Waypoints.Content").
      First(&route, "id = ?", uid)
   ```
3. Формирует полный ответ с контентом
4. Возвращает JSON

**Ответ (с контентом):**
```json
{
  "route_id": "ea7a7092-...",
  "waypoints": [
    {
      "id": "waypoint-1",
      "name": "ВДНХ",
      "content": {
        "text": "Перед вами знаменитая ВДНХ...",
        "audio_url": "/api/audio/waypoint-1",
        "duration_seconds": 180,
        "photos": ["url1", "url2"]
      }
    }
  ]
}
```

---

## 🔄 Полный Поток Данных

### Сценарий: Пользователь генерирует маршрут

```
КЛИЕНТ                 API HANDLER           SERVICES              БАЗА ДАННЫХ        ВНЕШНИЕ API
  │                         │                    │                      │                  │
  │ POST /routes/generate   │                    │                      │                  │
  ├────────────────────────>│                    │                      │                  │
  │                         │                    │                      │                  │
  │                         │ FindNearby()       │                      │                  │
  │                         ├───────────────────>│                      │                  │
  │                         │                    │  SELECT * FROM pois  │                  │
  │                         │                    │  WHERE epoch IN (...)│                  │
  │                         │                    ├─────────────────────>│                  │
  │                         │                    │                      │                  │
  │                         │                    │<─────────────────────┤                  │
  │                         │                    │   [POI1, POI2, ...]  │                  │
  │                         │                    │                      │                  │
  │                         │ [filtered POIs]    │                      │                  │
  │                         │<───────────────────┤                      │                  │
  │                         │                    │                      │                  │
  │                         │  INSERT route      │                      │                  │
  │                         ├──────────────────────────────────────────>│                  │
  │                         │                    │                      │                  │
  │                         │  INSERT waypoints  │                      │                  │
  │                         ├──────────────────────────────────────────>│                  │
  │                         │                    │                      │                  │
  │  {route_id, waypoints}  │                    │                      │                  │
  │<────────────────────────┤                    │                      │                  │
  │                         │                    │                      │                  │
  │                         │ go generateContent()                      │                  │
  │                         ├───────────────────>│                      │                  │
  │                         │                    │                      │                  │
  │                         │                    │ GenerateDescription()                   │
  │                         │                    ├────────────────────────────────────────>│
  │                         │                    │                      │   YandexGPT API  │
  │                         │                    │                      │                  │
  │                         │                    │<────────────────────────────────────────┤
  │                         │                    │        {text}        │                  │
  │                         │                    │                      │                  │
  │                         │                    │ GenerateAudio()      │                  │
  │                         │                    ├────────────────────────────────────────>│
  │                         │                    │                      │   Yandex TTS     │
  │                         │                    │                      │                  │
  │                         │                    │<────────────────────────────────────────┤
  │                         │                    │      {audio.mp3}     │                  │
  │                         │                    │                      │                  │
  │                         │                    │  INSERT content      │                  │
  │                         │                    ├─────────────────────>│                  │
  │                         │                    │                      │                  │
  │                         │                    │                      │                  │
  │ GET /routes/{id}        │                    │                      │                  │
  ├────────────────────────>│                    │                      │                  │
  │                         │  SELECT route      │                      │                  │
  │                         │  WITH waypoints    │                      │                  │
  │                         │  AND content       │                      │                  │
  │                         ├──────────────────────────────────────────>│                  │
  │                         │                    │                      │                  │
  │                         │<──────────────────────────────────────────┤                  │
  │  {route + content}      │   [full data]      │                      │                  │
  │<────────────────────────┤                    │                      │                  │
  │                         │                    │                      │                  │
  │ GET /audio/{waypoint}   │                    │                      │                  │
  ├────────────────────────>│                    │                      │                  │
  │                         │  SELECT content    │                      │                  │
  │                         ├──────────────────────────────────────────>│                  │
  │                         │                    │                      │                  │
  │                         │<──────────────────────────────────────────┤                  │
  │  audio.mp3 (binary)     │   {audio_path}     │                      │                  │
  │<────────────────────────┤                    │                      │                  │
  │                         │  Read file & send  │                      │                  │
```

---

## 📡 API Endpoints - Подробная Документация

### 1. Health Check

**Endpoint:** `GET /api/health`

**Описание:** Проверка работоспособности сервера

**Запрос:**
```bash
curl http://localhost:8080/api/health
```

**Ответ:**
```json
{
  "status": "ok",
  "message": "Audioguid API is running"
}
```

---

### 2. Список мест интереса

**Endpoint:** `GET /api/pois`

**Описание:** Получение всех POI или фильтрация

**Query параметры:**
- `epoch` - фильтр по эпохе (`medieval`, `imperial`, `soviet`, `modern`)
- `category` - фильтр по категории (`architecture`, `history`, `art`, `culture`, `religion`)

**Примеры:**

```bash
# Все POI
curl http://localhost:8080/api/pois

# Советская архитектура
curl "http://localhost:8080/api/pois?epoch=soviet&category=architecture"

# Средневековая история
curl "http://localhost:8080/api/pois?epoch=medieval&category=history"
```

**Ответ:**
```json
[
  {
    "ID": "179fd8c2-37cb-4c7d-8d7b-7fe0fd564d7f",
    "Name": "ВДНХ",
    "Description": "Выставка достижений народного хозяйства СССР",
    "Latitude": 55.8304,
    "Longitude": 37.6325,
    "Epoch": "soviet",
    "Category": "architecture",
    "Importance": 10,
    "YearBuilt": 1939,
    "Architect": "Вячеслав Олтаржевский",
    "Style": "Сталинский ампир",
    "Photos": ["url1", "url2"]
  }
]
```

---

### 3. Детали одного места

**Endpoint:** `GET /api/pois/:poi_id`

**Описание:** Получение подробной информации о конкретном месте

**Пример:**
```bash
curl http://localhost:8080/api/pois/179fd8c2-37cb-4c7d-8d7b-7fe0fd564d7f
```

**Ответ:** Один объект POI

---

### 4. Генерация маршрута

**Endpoint:** `POST /api/routes/generate`

**Описание:** Создание нового маршрута на основе предпочтений

**Content-Type:** `application/json`

**Тело запроса:**
```json
{
  "start_point": {
    "lat": 55.7558,    // Широта начальной точки
    "lon": 37.6173     // Долгота начальной точки
  },
  "duration_minutes": 60,  // Длительность прогулки (15-180)
  "epochs": [              // Исторические эпохи (опционально)
    "soviet",
    "medieval"
  ],
  "interests": [           // Интересы (опционально)
    "architecture",
    "history"
  ],
  "max_waypoints": 5       // Максимум точек (опционально, по умолчанию 5)
}
```

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| start_point.lat | float | ✅ | Широта (55.0 - 56.0 для Москвы) |
| start_point.lon | float | ✅ | Долгота (37.0 - 38.0 для Москвы) |
| duration_minutes | int | ✅ | 15-180 минут |
| epochs | []string | ❌ | medieval, imperial, soviet, modern |
| interests | []string | ❌ | architecture, history, culture, religion, art |
| max_waypoints | int | ❌ | 1-10, по умолчанию 5 |

**Примеры запросов:**

**Советская архитектура (60 минут):**
```bash
curl -X POST http://localhost:8080/api/routes/generate \
  -H "Content-Type: application/json" \
  -d '{
    "start_point": {"lat": 55.7558, "lon": 37.6173},
    "duration_minutes": 60,
    "epochs": ["soviet"],
    "interests": ["architecture"]
  }'
```

**Средневековая история (45 минут):**
```bash
curl -X POST http://localhost:8080/api/routes/generate \
  -H "Content-Type: application/json" \
  -d '{
    "start_point": {"lat": 55.7539, "lon": 37.6208},
    "duration_minutes": 45,
    "epochs": ["medieval"],
    "interests": ["history", "religion"]
  }'
```

**Смешанный маршрут (120 минут):**
```bash
curl -X POST http://localhost:8080/api/routes/generate \
  -H "Content-Type: application/json" \
  -d '{
    "start_point": {"lat": 55.7558, "lon": 37.6173},
    "duration_minutes": 120,
    "epochs": ["soviet", "medieval", "imperial"],
    "interests": ["architecture", "history", "art"],
    "max_waypoints": 8
  }'
```

**Ответ (сразу после создания):**
```json
{
  "route_id": "ea7a7092-8fa1-44c2-a656-55f38d4822e3",
  "name": "Советская Москва: Архитектура",
  "total_distance": 0,
  "estimated_duration": 60,
  "waypoints": [
    {
      "id": "7e127c92-12bb-4119-94dc-72b75abd1180",
      "name": "Красная площадь",
      "description": "Главная площадь Москвы",
      "coordinates": {
        "lat": 55.7539,
        "lon": 37.6208
      },
      "epoch": "medieval",
      "category": "history",
      "order": 1,
      "content": null  // Генерируется асинхронно!
    },
    {
      "id": "3a3546bb-e90a-4455-b039-e56f75908b86",
      "name": "Кремль",
      "description": "Древняя крепость",
      "coordinates": {
        "lat": 55.752,
        "lon": 37.6175
      },
      "epoch": "medieval",
      "category": "history",
      "order": 2,
      "content": null
    }
  ]
}
```

**Важно:** `content` будет `null` сразу после создания, так как текст и аудио генерируются асинхронно (1-2 минуты на точку).

---

### 5. Получение маршрута с контентом

**Endpoint:** `GET /api/routes/:route_id`

**Описание:** Получение полных деталей маршрута (с сгенерированным контентом)

**Пример:**
```bash
# Используйте route_id из предыдущего запроса
curl http://localhost:8080/api/routes/ea7a7092-8fa1-44c2-a656-55f38d4822e3
```

**Ответ (после генерации контента):**
```json
{
  "route_id": "ea7a7092-8fa1-44c2-a656-55f38d4822e3",
  "name": "Советская Москва: Архитектура",
  "total_distance": 4500,
  "estimated_duration": 60,
  "waypoints": [
    {
      "id": "7e127c92-12bb-4119-94dc-72b75abd1180",
      "name": "Красная площадь",
      "description": "Главная площадь Москвы",
      "coordinates": {
        "lat": 55.7539,
        "lon": 37.6208
      },
      "epoch": "medieval",
      "category": "history",
      "order": 1,
      "content": {
        "text": "Перед вами раскинулась легендарная Красная площадь...",
        "audio_url": "/api/audio/7e127c92-12bb-4119-94dc-72b75abd1180",
        "duration_seconds": 180,
        "photos": ["url1", "url2"]
      }
    }
  ]
}
```

**Если контент еще генерируется:**
```json
{
  "waypoints": [{
    "content": null  // Подождите 1-2 минуты и повторите запрос
  }]
}
```

---

### 6. Скачивание аудио

**Endpoint:** `GET /api/audio/:waypoint_id`

**Описание:** Получение MP3 файла для конкретной точки маршрута

**Пример:**
```bash
# Скачать аудио для первой точки
curl http://localhost:8080/api/audio/7e127c92-12bb-4119-94dc-72b75abd1180 \
  -o waypoint1.mp3

# Воспроизвести через ffplay
ffplay waypoint1.mp3
```

**Ответ:** Binary MP3 file

**Headers:**
```
Content-Type: audio/mpeg
Content-Length: 245678
```

**Ошибки:**
```json
// Если аудио еще не сгенерировано
{
  "error": "Audio not generated yet"
}

// Если waypoint не найден
{
  "error": "Audio not found"
}
```

---

## 💾 База Данных

### Схема PostgreSQL

```sql
-- Таблица мест интереса
CREATE TABLE pois (
    id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name          TEXT NOT NULL,
    description   TEXT,
    latitude      NUMERIC NOT NULL,
    longitude     NUMERIC NOT NULL,
    epoch         TEXT,              -- medieval, imperial, soviet, modern
    category      TEXT,              -- architecture, history, art, culture, religion
    importance    BIGINT DEFAULT 5,  -- 1-10
    year_built    BIGINT,
    architect     TEXT,
    style         TEXT,
    photos        TEXT[],            -- Массив URL
    wikipedia_url TEXT,
    metadata      JSONB,
    created_at    TIMESTAMP DEFAULT NOW(),
    updated_at    TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_pois_epoch ON pois(epoch);
CREATE INDEX idx_pois_category ON pois(category);

-- Таблица маршрутов
CREATE TABLE routes (
    id                 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name               TEXT,
    description        TEXT,
    total_distance     NUMERIC,        -- метры
    estimated_duration BIGINT,         -- минуты
    epochs             TEXT[],
    categories         TEXT[],
    created_at         TIMESTAMP DEFAULT NOW()
);

-- Таблица точек маршрута
CREATE TABLE waypoints (
    id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    route_id   UUID NOT NULL REFERENCES routes(id) ON DELETE CASCADE,
    poi_id     UUID NOT NULL REFERENCES pois(id),
    "order"    BIGINT NOT NULL,        -- Порядок точки (1, 2, 3...)
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_waypoints_route_id ON waypoints(route_id);

-- Таблица контента
CREATE TABLE contents (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    waypoint_id UUID NOT NULL UNIQUE REFERENCES waypoints(id) ON DELETE CASCADE,
    text        TEXT NOT NULL,
    audio_url   TEXT,
    audio_path  TEXT,
    duration    BIGINT,                -- секунды
    photos      TEXT[],
    generated   BOOLEAN DEFAULT FALSE,
    created_at  TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_contents_waypoint_id ON contents(waypoint_id);
```

### Связи между таблицами

```
pois (12 записей)
  ├─ ВДНХ
  ├─ МГУ
  ├─ Останкино
  └─ ...

routes
  └─ "Советская Москва"
      ├─ waypoints
      │   ├─ waypoint_1 → poi_id: ВДНХ → content_1
      │   ├─ waypoint_2 → poi_id: МГУ → content_2
      │   └─ waypoint_3 → poi_id: Останкино → content_3

contents
  ├─ content_1: text + audio для ВДНХ
  ├─ content_2: text + audio для МГУ
  └─ content_3: text + audio для Останкино
```

### Примеры запросов к БД

**Все советские памятники:**
```sql
SELECT name, latitude, longitude, year_built
FROM pois
WHERE epoch = 'soviet'
ORDER BY importance DESC;
```

**Маршрут с точками:**
```sql
SELECT
  r.name as route_name,
  w.order,
  p.name as poi_name,
  p.latitude,
  p.longitude
FROM routes r
JOIN waypoints w ON w.route_id = r.id
JOIN pois p ON p.id = w.poi_id
WHERE r.id = 'your-route-id'
ORDER BY w.order;
```

**Статистика по эпохам:**
```sql
SELECT epoch, COUNT(*) as count
FROM pois
GROUP BY epoch;
```

---

## 🚀 Как Запустить

### Вариант 1: Простой запуск (рекомендуется)

```bash
# 1. Перейти в директорию backend
cd /Users/dimmy-kor/Projects/2gis_hackaton/backend

# 2. Установить переменную окружения
export DATABASE_URL="postgresql://nike:<password>@51.250.86.178:<port>/audioguid?sslmode=disable"

# 3. Запустить сервер
go run cmd/server/main.go
```

**Вывод:**
```
2025/10/05 00:42:16 🚀 Server starting on port 8080
[GIN-debug] GET    /api/health
[GIN-debug] POST   /api/routes/generate
[GIN-debug] GET    /api/routes/:route_id
[GIN-debug] GET    /api/pois
[GIN-debug] GET    /api/pois/:poi_id
[GIN-debug] GET    /api/audio/:waypoint_id
[GIN-debug] Listening and serving HTTP on :8080
```

**Проверка:**
```bash
curl http://localhost:8080/api/health
# {"status":"ok","message":"Audioguid API is running"}
```

---

### Вариант 2: С .env файлом

```bash
cd /Users/dimmy-kor/Projects/2gis_hackaton/backend

# Создать .env файл
cat > .env << 'EOF'
# База данных
DATABASE_URL=postgresql://nike:<password>@51.250.86.178:<port>/audioguid?sslmode=disable

# Yandex Cloud (для генерации контента)
YANDEX_API_KEY=your_api_key_here
YANDEX_FOLDER_ID=your_folder_id_here
YANDEX_VOICE=alena

# 2GIS
GAPIS_API_KEY=1bfdf79c-0a09-4ea6-882e-afc09421c8d5
GAPIS_APP_ID=ru.2gishackathon.app06.02
GAPIS_KEY_FILE=./keys/2gis.key

# Server
PORT=8080
EOF

# Запустить
go run cmd/server/main.go
```

---

### Вариант 3: Компиляция в бинарник

```bash
cd /Users/dimmy-kor/Projects/2gis_hackaton/backend

# Скомпилировать
go build -o audioguid cmd/server/main.go

# Запустить
export DATABASE_URL="postgresql://nike:<password>@51.250.86.178:<port>/audioguid?sslmode=disable"
./audioguid
```

---

### Автоматический рестарт при изменениях (для разработки)

```bash
# Установить air
go install github.com/cosmtrek/air@latest

# Создать конфиг
cat > .air.toml << 'EOF'
root = "."
tmp_dir = "tmp"

[build]
cmd = "go build -o ./tmp/main cmd/server/main.go"
bin = "tmp/main"
include_ext = ["go"]
exclude_dir = ["tmp", "vendor"]
EOF

# Запустить с hot-reload
air
```

---

## 📖 Примеры Использования

### Сценарий 1: Советская архитектура (60 минут)

```bash
# Шаг 1: Создать маршрут
ROUTE=$(curl -s -X POST http://localhost:8080/api/routes/generate \
  -H "Content-Type: application/json" \
  -d '{
    "start_point": {"lat": 55.7558, "lon": 37.6173},
    "duration_minutes": 60,
    "epochs": ["soviet"],
    "interests": ["architecture"],
    "max_waypoints": 3
  }')

# Шаг 2: Получить route_id
ROUTE_ID=$(echo $ROUTE | python3 -c "import sys,json; print(json.load(sys.stdin)['route_id'])")
echo "Маршрут создан: $ROUTE_ID"

# Шаг 3: Подождать генерации контента
echo "Ждем генерации контента (60 секунд)..."
sleep 60

# Шаг 4: Получить полный маршрут
curl -s http://localhost:8080/api/routes/$ROUTE_ID | python3 -m json.tool

# Шаг 5: Скачать аудио для первой точки
WAYPOINT_ID=$(curl -s http://localhost:8080/api/routes/$ROUTE_ID | \
  python3 -c "import sys,json; print(json.load(sys.stdin)['waypoints'][0]['id'])")

curl http://localhost:8080/api/audio/$WAYPOINT_ID -o waypoint1.mp3
echo "Аудио сохранено: waypoint1.mp3"
```

---

### Сценарий 2: Поиск ближайших мест

```bash
# Найти советскую архитектуру
curl -s "http://localhost:8080/api/pois?epoch=soviet&category=architecture" | \
  python3 -c "
import sys, json
data = json.load(sys.stdin)
for poi in data:
    print(f\"{poi['Name']}: {poi['Latitude']}, {poi['Longitude']}\")
"
```

**Вывод:**
```
ВДНХ: 55.8304, 37.6325
МГУ им. М.В. Ломоносова: 55.7033, 37.5297
Останкинская телебашня: 55.8194, 37.6119
Гостиница 'Украина': 55.7526, 37.5676
```

---

### Сценарий 3: Добавление нового POI

```bash
# Через psql
PGPASSWORD=<password> psql -h 51.250.86.178 -U nike -d audioguid << 'EOF'
INSERT INTO pois (name, description, latitude, longitude, epoch, category, importance, year_built)
VALUES (
  'Парк Победы',
  'Мемориальный комплекс победы в ВОВ',
  55.7325,
  37.5086,
  'soviet',
  'history',
  9,
  1995
);
EOF
```

Или через Python скрипт:
```python
# scripts/add_poi.py
import psycopg2

conn = psycopg2.connect(
    "postgresql://nike:<password>@51.250.86.178:<port>/audioguid"
)
cursor = conn.cursor()

cursor.execute("""
    INSERT INTO pois (name, description, latitude, longitude, epoch, category, importance)
    VALUES (%s, %s, %s, %s, %s, %s, %s)
""", (
    "Парк Победы",
    "Мемориальный комплекс",
    55.7325, 37.5086,
    "soviet", "history", 9
))

conn.commit()
print("✅ POI добавлен")
```

---

## 🔧 Troubleshooting

### Проблема 1: "connection refused" при запуске

**Причина:** PostgreSQL недоступен

**Решение:**
```bash
# Проверить подключение
PGPASSWORD=<password> psql -h 51.250.86.178 -U nike -d audioguid -c "SELECT 1;"

# Если не работает, проверить:
# 1. IP адрес сервера (51.250.86.178)
# 2. Порт (<port>)
# 3. Пароль (<password>)
# 4. Firewall rules на VM
```

---

### Проблема 2: "Failed to create waypoints"

**Причина:** Проблема с foreign key constraints

**Решение:**
```bash
# Проверить схему
PGPASSWORD=<password> psql -h 51.250.86.178 -U nike -d audioguid -c "\d waypoints"

# Пересоздать constraint
PGPASSWORD=<password> psql -h 51.250.86.178 -U nike -d audioguid << 'EOF'
ALTER TABLE waypoints DROP CONSTRAINT IF EXISTS fk_waypoints_poi;
ALTER TABLE waypoints ADD CONSTRAINT fk_waypoints_poi 
  FOREIGN KEY (poi_id) REFERENCES pois(id);
EOF
```

---

### Проблема 3: "No POIs found"

**Причина:** Нет POI в радиусе поиска

**Решение:**
```bash
# 1. Увеличить duration_minutes (больше радиус)
# 2. Использовать шире фильтры (больше epochs и interests)
# 3. Изменить start_point ближе к POI

# Проверить доступные POI
curl -s http://localhost:8080/api/pois | python3 -m json.tool | grep -A2 -B2 "Name"
```

---

### Проблема 4: "YandexGPT API error"

**Причина:** Неправильные или отсутствующие API ключи

**Решение:**
```bash
# Проверить переменные окружения
echo $YANDEX_API_KEY
echo $YANDEX_FOLDER_ID

# Если пустые, установить:
export YANDEX_API_KEY="AQVN..."
export YANDEX_FOLDER_ID="b1g..."

# Или добавить в .env файл

# Протестировать API ключ
curl -X POST https://llm.api.cloud.yandex.net/foundationModels/v1/completion \
  -H "Authorization: Api-Key $YANDEX_API_KEY" \
  -H "x-folder-id: $YANDEX_FOLDER_ID" \
  -H "Content-Type: application/json" \
  -d '{
    "modelUri": "gpt://'"$YANDEX_FOLDER_ID"'/yandexgpt/latest",
    "completionOptions": {"temperature": 0.7, "maxTokens": "100"},
    "messages": [{"role": "user", "text": "Привет!"}]
  }'
```

---

### Проблема 5: Контент не генерируется

**Причина:** Генерация идет асинхронно, нужно подождать

**Решение:**
```bash
# Проверить статус через 1-2 минуты
curl -s http://localhost:8080/api/routes/$ROUTE_ID | \
  python3 -c "
import sys, json
data = json.load(sys.stdin)
for wp in data['waypoints']:
    status = '✅' if wp.get('content') else '⏳'
    print(f\"{status} {wp['name']}: {wp.get('content', 'генерируется...')}\")
"
```

---

## 📊 Полезные Команды

### Проверка статуса сервера
```bash
curl http://localhost:8080/api/health
```

### Подсчет POI по эпохам
```bash
curl -s http://localhost:8080/api/pois | \
  python3 -c "
import sys, json
from collections import Counter
data = json.load(sys.stdin)
epochs = Counter(poi['Epoch'] for poi in data)
for epoch, count in epochs.items():
    print(f'{epoch}: {count}')
"
```

### Проверка размера базы данных
```bash
PGPASSWORD=<password> psql -h 51.250.86.178 -U nike -d audioguid -c "
SELECT
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
"
```

### Логи генерации контента
```bash
# В коде добавлено логирование
tail -f /tmp/audioguid.log
```

---

## 🎓 Дополнительная Информация

### Используемые технологии

- **Go 1.21+** - Язык программирования
- **Gin Web Framework** - HTTP роутер
- **GORM** - ORM для PostgreSQL
- **PostgreSQL 16** - База данных
- **2GIS API** - Карты и маршруты
- **YandexGPT** - Генерация текста
- **Yandex SpeechKit** - Text-to-Speech

### Переменные окружения

| Переменная | Описание | Обязательна |
|------------|----------|-------------|
| DATABASE_URL | Connection string PostgreSQL | ✅ |
| YANDEX_API_KEY | API ключ Yandex Cloud | ❌* |
| YANDEX_FOLDER_ID | Folder ID Yandex Cloud | ❌* |
| YANDEX_VOICE | Голос TTS (alena, filipp) | ❌ |
| GAPIS_API_KEY | API ключ 2GIS | ✅ |
| PORT | Порт сервера (по умолчанию 8080) | ❌ |

*необходимы для генерации контента

### Зависимости Go

```go
require (
    github.com/gin-gonic/gin v1.9.1
    github.com/google/uuid v1.4.0
    github.com/joho/godotenv v1.5.1
    github.com/lib/pq v1.10.9
    gorm.io/driver/postgres v1.5.4
    gorm.io/gorm v1.25.5
)
```

---

**Документация завершена!** 🎉

Для вопросов или проблем создавайте issue в репозитории.
